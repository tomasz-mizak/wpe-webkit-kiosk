#!/bin/bash
# WPE Kiosk launcher â€” reads config and starts the kiosk binary
set -euo pipefail

PREFIX=/opt/wpe-webkit-kiosk
CONFIG=/etc/wpe-webkit-kiosk/config

# Defaults
URL="https://wpewebkit.org"
INSPECTOR_PORT="8080"
INSPECTOR_HTTP_PORT="8090"
CURSOR_VISIBLE="true"
EXTENSIONS_DIR="/opt/wpe-webkit-kiosk/extensions"

# Read config
if [ -f "$CONFIG" ]; then
    # shellcheck source=/dev/null
    . "$CONFIG"
fi

# Library paths
ARCH=$(uname -m)-linux-gnu
# Normalize: dpkg uses x86_64 -> x86_64-linux-gnu but multiarch triplet is x86_64-linux-gnu
case "$(uname -m)" in
    x86_64)  ARCH="x86_64-linux-gnu" ;;
    aarch64) ARCH="aarch64-linux-gnu" ;;
    armv7l)  ARCH="arm-linux-gnueabihf" ;;
    *)       ARCH="$(uname -m)-linux-gnu" ;;
esac
export LD_LIBRARY_PATH="${PREFIX}/lib/${ARCH}:${PREFIX}/lib:${LD_LIBRARY_PATH:-}"
export XDG_DATA_DIRS="${PREFIX}/share:${XDG_DATA_DIRS:-/usr/local/share:/usr/share}"

# WPEPlatform module path
export WPE_PLATFORM_MODULE_DIR="${PREFIX}/lib/${ARCH}/wpe-platform-2.0/modules"

# Remote inspector
export WEBKIT_INSPECTOR_SERVER="0.0.0.0:${INSPECTOR_PORT}"
export WEBKIT_INSPECTOR_HTTP_SERVER="0.0.0.0:${INSPECTOR_HTTP_PORT}"

# Cursor visibility
export WPE_KIOSK_CURSOR_VISIBLE="${CURSOR_VISIBLE}"

# Extensions
export WPE_KIOSK_EXTENSIONS_DIR="${EXTENSIONS_DIR}"

# --- Audio: D-Bus session bus ---
if [ -z "${DBUS_SESSION_BUS_ADDRESS:-}" ]; then
    DBUS_SESSION_BUS_ADDRESS="$(dbus-daemon --session --print-address --fork)"
    export DBUS_SESSION_BUS_ADDRESS
fi

# --- Audio: PipeWire stack ---
pipewire &
PIPEWIRE_PID=$!
sleep 0.3

pipewire-pulse &
PIPEWIRE_PULSE_PID=$!

wireplumber &
WIREPLUMBER_PID=$!
sleep 0.3

# Cleanup PipeWire processes on exit
cleanup_audio() {
    kill "$WIREPLUMBER_PID" "$PIPEWIRE_PULSE_PID" "$PIPEWIRE_PID" 2>/dev/null || true
    wait "$WIREPLUMBER_PID" "$PIPEWIRE_PULSE_PID" "$PIPEWIRE_PID" 2>/dev/null || true
}
trap cleanup_audio EXIT

"${PREFIX}/bin/wpe-webkit-kiosk-bin" "$URL"
