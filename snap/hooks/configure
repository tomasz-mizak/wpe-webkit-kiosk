#!/bin/bash
set -euo pipefail

# Handle daemon configuration changes.
daemon=$(snapctl get daemon)
case "$daemon" in
  true)
    # start the daemon
    if snapctl services "$SNAP_INSTANCE_NAME" | grep -q inactive; then
      snapctl start --enable "$SNAP_INSTANCE_NAME" 2>&1 || true
    fi
    ;;
  false)
    # stop the daemon
        snapctl stop --disable "$SNAP_INSTANCE_NAME" 2>&1 || true
    ;;
  *)
    echo "ERROR: Set 'daemon' to one of true|false"
    exit 1
    ;;
esac

# Set default for url.
if [ -z "$(snapctl get url)" ]; then
    snapctl set url="https://wpewebkit.org";
fi

# Set default for devmode.
if [ -z "$(snapctl get devmode)" ]; then
    snapctl set devmode=false;
fi

# Set default for debug.
if [ -z "$(snapctl get debug)" ]; then
    snapctl set debug=false;
fi

# Set default for error-to-console.
if [ -z "$(snapctl get error-to-console)" ]; then
    snapctl set error-to-console=false;
fi

# Set default for bg-color.
if [ -z "$(snapctl get bg-color)" ]; then
    snapctl set bg-color=black;
fi

# Set default for inspector-server-port.
if [ -z "$(snapctl get inspector-server-port)" ]; then
    snapctl set inspector-server-port=8080;
fi

# Set default for inspector-http-server-port.
if [ -z "$(snapctl get inspector-http-server-port)" ]; then
    snapctl set inspector-http-server-port=8090;
fi

# Configuration validators. Adapted from https://git.launchpad.net/~gerboland/+git/chromium-snap/tree/snap/hooks/configure?h=mir-kiosk

validate_url() {
    url=$1
    regex='^http(s)?://*'
    if [[ ! $url =~ $regex ]]; then
        echo "Error: URL \"${url}\" needs to start with http:// or https://"
        exit 1
    fi
}

validate_boolean() {
    if [[ ! $1 =~ (true|false) ]]; then
        echo "Error: \"$2\" accepts only true/false. Got \"$1\""
        exit 1
    fi
}

validate_integer() {
    port=$1
    if ! [[ $port =~ ^[0-9]{2,6}$ && $port -ge 1 && $port -le 65536 ]]; then
        echo "Error: \"$2\" requires a valid port number with 2-6 digits. Got \"$1\""
        exit 1
    fi
}

validate_url "$(snapctl get url)"
validate_boolean "$(snapctl get devmode)"
validate_boolean "$(snapctl get debug)"
validate_boolean "$(snapctl get error-to-console)"
validate_integer "$(snapctl get inspector-server-port)"
validate_integer "$(snapctl get inspector-http-server-port)"

# (Re)start the daemon to pick up changes.
# Source: https://github.com/MirServer/ubuntu-frame/blob/7c5f852575634bad9c1912bf0a78ed6c5c5b7168/snap/hooks/configure#L104
if [ "$(snapctl get daemon)" = "true" ]; then
  if snapctl services "$SNAP_INSTANCE_NAME.daemon" | grep -q inactive; then
    snapctl start --enable "$SNAP_INSTANCE_NAME.daemon" 2>&1 || true
  else
    snapctl restart "$SNAP_INSTANCE_NAME.daemon" || true
  fi
else
  snapctl stop --disable "$SNAP_INSTANCE_NAME.daemon" 2>&1 || true
fi
